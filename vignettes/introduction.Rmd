---
title: "Getting started"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(EpiSoon)
```


## Introduction

This vignette briefly outlines the functionality of `EpiSoon`. To get started load the required packages.


* Load the package (`bsts` for models, `ggplot2` for plotting, and `cowplot` for theming)

```{r, message = FALSE}
library(EpiSoon)
library(bsts)
library(cowplot)
library(dplyr)
```


## Forecast Rts, score and plot


* We use an example dataframe built into the package but this could be replaced with your own data.

```{r}
EpiSoon::example_obs_rts
```

* Fit a `bsts` model and produce a Rt forecast
```{r}
rt_forecast <- forecast_rt(EpiSoon::example_obs_rts[1:10, ],
                       model = function(ss, y){bsts::AddSemilocalLinearTrend(ss, y = y)},
                       horizon = 21, samples = 10)

rt_forecast
```

* Score the forecast

```{r}
rt_scores <- score_forecast(rt_forecast, EpiSoon::example_obs_rts)

rt_scores
```

* Summarise the forecast scores

```{r}
summarise_scores(rt_scores)
```

* Summarise the forecast

```{r}
summarised_rt_forecast <- summarise_forecast(rt_forecast)

summarised_rt_forecast
```

* Plot the forecast against observed data

```{r}
plot_forecast(summarised_rt_forecast, EpiSoon::example_obs_rts)
```

## Forecast cases, score and plot

* Forecasting cases requires the observed cases on which the observed Rt estimates were based

```{r}
EpiSoon::example_obs_cases
```

* It also requires an assumption to be made about the serial interval (defined using probability distribution).

```{r}
EpiSoon::example_serial_interval
```

* Forecast cases (using the case data on which the observed Rt estimates were based)

```{r}
case_forecast <- forecast_cases(EpiSoon::example_obs_cases, rt_forecast,
                                serial_interval = EpiSoon::example_serial_interval)

case_forecast
```


* Score the cases forecast

```{r}
case_scores <- score_case_forecast(case_forecast, EpiSoon::example_obs_cases)

case_scores
```

* Summarise the cases scores

```{r}
summarise_scores(case_scores)
```

* Summarise the cases forecast

```{r}
summarised_case_forecast <- summarise_case_forecast(case_forecast)

summarised_case_forecast
```

* Plot the forecast against observed case data

```{r}
plot_forecast(summarised_case_forecast, EpiSoon::example_obs_cases)
```

## Use iterative fitting to explore a forecast


## Evaluate a model


## Wrapper functions

`EpiSoon` provides several wrapper functions (`compare_models` and `compare_timeseries`). These both wrap `evaluate_model` and can be used to rapidly explore several forecasting models (`compare_models`) against multiple time series (`compare_timeseries`). All lower level summary and plotting functions can be then used with the output of these wrappers to explore the results. See the function documentation for further details.

## Compare models across timeseries

* Define example observations.

```{r}
obs_rts <- data.frame(rt = 1:20,
                      date = as.Date("2020-01-01")
                      + lubridate::days(1:20))

obs_cases <- data.frame(cases = 5:24, 
                        date = as.Date("2020-01-01")
                        + lubridate::days(1:20))
```

* Forecast a timeseries of $R_t$ values using a semi-local trend model and  summarise it.

```{r}
samples_rt <- forecast_rt(rts = obs_rts[1:10, ],
                          model = function(ss, y){bsts::AddSemilocalLinearTrend(ss, y = y)},
                          horizon = 7, samples = 10)

## Summarise R_t forecasts
summarised_forecast_rt <- summarise_forecast(samples_rt)
 
summarised_forecast_rt
```

* Forecast incidences using a semi-local trend model and  summarise it.

```{r}
samples_cases <- forecast_cases(cases = obs_cases[1:10, ],
                                fit_samples = samples_rt, 
                                serial_interval = EpiNow::covid_serial_intervals)

## Summarise case forecast
summarised_forecast_cases <- summarise_case_forecast(samples_cases)
 
summarised_forecast_cases
```

* Score the $R_t$ forecast

```{r}
scores <- score_forecast(samples_rt, obs_rts)

summarise_scores(scores)
```

* Score the case forecast

```{r}
scores_cases <- score_case_forecast(samples_cases, obs_cases)

summarise_scores(scores_cases)
```

* Plot the $R_t$ forecast

```{r}
 ## Plot forecast
 plot_forecast(summarised_forecast_rt, obs_rts)
```

* Plot the case forecast

```{r}
 ## Plot forecasted cases
 plot_forecast(summarised_forecast_cases, obs_cases)
```


* Iteratively fit the forecast.

```{r} 
forecast_eval <- evaluate_model(obs_rts = obs_rts,
                                obs_cases = obs_cases, 
                                model = function(ss, y){bsts::AddSemilocalLinearTrend(ss, y = y)},
                                serial_interval = example_serial_interval,
                                horizon = 7, samples = 10)

forecast_rts <- forecast_eval$forecast_rts
```

* Plot the iterative Rt forecast

```{r}
## Plot forecast_rt
plot_forecast_evaluation(forecast_rts, obs_rts, horizon_to_plot = c(1, 3, 7)) +
   ggplot2::facet_wrap(~ horizon, ncol = 1) +
   cowplot::panel_border() 
## currently still returns warning: "longer object length is not a multiple of shorter object length"

```


* Plot the iterative case forecast

```{r}
forecast_cases <- forecast_eval$forecast_cases

## Plot forecast_cases
plot_forecast_evaluation(forecast_cases, obs_cases, horizon_to_plot = c(1, 3, 7)) +
   ggplot2::facet_wrap(~ horizon, ncol = 1, scales = "free") +
   cowplot::panel_border() 
## currently still returns warning: "longer object length is not a multiple of shorter object length"


```

## Evaluate across models

* Define a list of models.

```{r} 
## List of forecasting bsts models wrapped in functions.
models <- list("Sparse AR" = function(ss, y){bsts::AddAutoAr(ss, y = y, lags = 7)},
                "Semi-local linear trend" = function(ss, y){bsts::AddSemilocalLinearTrend(ss, y = y)})
```

* Compare across models.

```{r}
evaluations <- compare_models(obs_rts = obs_rts, 
                              obs_cases = obs_cases, 
                              models = models, 
                              serial_interval = example_serial_interval,
                              horizon = 7, samples = 10)
```

* Plot evaluation of models in terms of $R_t$ over a set of time horizons.

```{r}
plot_forecast_evaluation(evaluations$forecast_rts, obs_rts, c(1, 3, 7)) +
   ggplot2::facet_grid(model ~ horizon) +
   cowplot::panel_border() 
```

* Plot evaluation of models in terms of cases over a set of time horizons.

```{r}
plot_forecast_evaluation(evaluations$forecast_cases, obs_cases, c(1, 3, 7)) +
   ggplot2::facet_wrap(model ~ horizon, scales = "free") +
   cowplot::panel_border() 
```


* Score across models

```{r}
summarise_scores(evaluations$rt_scores)

summarise_scores(evaluations$case_scores)
```


### Evaluate across regions and models

* Define multiple timeseries

```{r} 
obs_rts_ts <- obs_rts %>% 
   dplyr::mutate(timeseries = "Region 1") %>% 
   dplyr::bind_rows(
      obs_rts %>% 
   dplyr::mutate(timeseries = "Region 2")
   )

obs_cases_ts <- obs_cases %>% 
   dplyr::mutate(timeseries = "Region 1") %>% 
   dplyr::bind_rows(
      obs_cases %>% 
   dplyr::mutate(timeseries = "Region 2")
   )



```
* Compare across regions and models

```{r} 
evaluations <- compare_timeseries(obs_rts = obs_rts_ts, 
                                  obs_cases = obs_cases_ts, 
                                  models = models,
                                  serial_interval = example_serial_interval,
                                  horizon = 7, samples = 10)


```


* Plot comparison in terms of $R_t$

```{r}
plot_forecast_evaluation(evaluations$forecast_rts, obs_rts_ts, c(7)) +
   ggplot2::facet_grid(model ~ timeseries) +
   cowplot::panel_border()
```


* Plot comparison in terms of $R_t$

```{r}
plot_forecast_evaluation(evaluations$forecast_cases, obs_cases_ts, c(7)) +
   ggplot2::facet_wrap(model ~ timeseries, scales = "free") +
   cowplot::panel_border()
```

* Summarise CRPS by region

```{r}
summarise_scores(evaluations$rt_scores, "timeseries", sel_scores = "crps")
summarise_scores(evaluations$case_scores, "timeseries", sel_scores = "crps")
```

* Summarise logs by horizon

```{r}
summarise_scores(evaluations$rt_scores, "horizon", sel_scores = "logs")
```
